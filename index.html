<!DOCTYPE html>
<html lang="en" data-theme="fittrack">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>FitTrack</title>

  <!-- PWA Config -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FitTrack">
  <link rel="apple-touch-icon" href="icon.svg">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  
  <!-- Tailwind & DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- TEMPLATE: Preference Selector Modal -->
  <script type="text/x-template" id="preference-selector-template">
    <div v-if="isOpen" class="fixed inset-0 z-[70] flex items-end justify-center sm:items-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="close"></div>
        <div class="relative w-full max-w-lg bg-base-100 rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 shadow-2xl transform transition-transform animate-slide-up h-[70vh] flex flex-col">
            <div class="w-12 h-1.5 bg-base-300 rounded-full mx-auto mb-6 opacity-50 flex-shrink-0"></div>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-black text-base-content">Ê∑ªÂä†{{ category }}ËÆ≠ÁªÉ</h3>
                <button class="btn btn-sm btn-circle btn-ghost" @click="close">‚úï</button>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide grid grid-cols-3 gap-3 content-start pb-24">
                <button 
                    v-for="action in actions" 
                    :key="action.id"
                    @click="toggle(action.id)"
                    class="flex flex-col items-center justify-center p-3 rounded-2xl transition-all border-2 relative h-28"
                    :class="isSelected(action.id) ? 'bg-primary/10 border-primary' : 'bg-base-200 border-transparent opacity-60 hover:opacity-100'"
                >
                    <div class="text-3xl mb-2">{{ action.icon }}</div>
                    <div class="text-xs font-bold text-center leading-tight line-clamp-2">{{ action.label }}</div>
                    <div v-if="isSelected(action.id)" class="absolute top-2 right-2 text-primary bg-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] shadow-sm">‚úì</div>
                </button>
                <div v-if="actions.length === 0" class="col-span-3 text-center py-10 text-base-content/40">
                    ÊöÇÊó†Ê≠§Á±ªÂä®‰Ωú
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-base-100 via-base-100 to-transparent">
                <button 
                    class="btn btn-primary btn-lg w-full rounded-2xl font-bold shadow-xl shadow-primary/20" 
                    @click="save"
                    :disabled="loading"
                >
                    <span v-if="loading" class="loading loading-spinner"></span>
                    <span v-else>‰øùÂ≠òËÆæÁΩÆ</span>
                </button>
            </div>
        </div>
    </div>
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {},
      },
      daisyui: {
        themes: [
          {
            fittrack: {
              "primary": "#6366f1",
              "secondary": "#ec4899",
              "accent": "#8b5cf6",
              "neutral": "#1f2937",
              "base-100": "#ffffff",
              "base-200": "#f3f4f6",
              "base-300": "#e5e7eb",
              "info": "#3abff8",
              "success": "#36d399",
              "warning": "#fbbd23",
              "error": "#f87272",
              "--rounded-box": "1rem",
              "--rounded-btn": "0.8rem",
              "--rounded-badge": "1.9rem",
              "--animation-btn": "0.25s",
              "--animation-input": "0.2s",
              "--btn-focus-scale": "0.95",
              "--border-btn": "1px",
              "--tab-border": "1px",
              "--tab-radius": "0.5rem",
            },
          },
          "light",
          "dark",
        ],
      },
    }
  </script>

  <!-- Libraries -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/vue-demi"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
  <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    /* Global Styles & Animations */
    .animate-bounce-slow { animation: bounce 3s infinite; }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes bounce {
      0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
      50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-base-200/50 min-h-screen">
  <div id="app">
    <router-view></router-view>
  </div>

  <!-- TEMPLATE: Login -->
  <script type="text/x-template" id="login-template">
    <div class="min-h-screen flex flex-col items-center justify-center bg-base-100 p-6 relative overflow-hidden">
        <!-- Decorative blobs -->
        <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-primary/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-secondary/20 rounded-full blur-3xl"></div>
    
        <div class="w-full max-w-sm z-10">
          <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-tr from-primary to-accent shadow-lg shadow-primary/30 text-4xl mb-6">
              üí™
            </div>
            <h1 class="text-4xl font-black text-base-content mb-2 tracking-tight">FitTrack</h1>
            <p class="text-base-content/60 font-medium">Ê¨¢ËøéÂõûÊù•ÔºåËøêÂä®ÂÅ•Â∞ÜÔºÅ</p>
          </div>
          
          <div class="space-y-4">
            <div class="form-control w-full">
              <input 
                type="text" 
                v-model="username" 
                placeholder="Áî®Êà∑Âêç" 
                class="input input-lg input-bordered w-full bg-base-200/50 border-none focus:ring-2 focus:ring-primary/50 focus:bg-base-100 transition-all rounded-2xl font-medium placeholder:text-base-content/30" 
              />
            </div>
            
            <div class="form-control w-full">
              <input 
                type="password" 
                v-model="password" 
                placeholder="ÂØÜÁ†Å" 
                class="input input-lg input-bordered w-full bg-base-200/50 border-none focus:ring-2 focus:ring-primary/50 focus:bg-base-100 transition-all rounded-2xl font-medium placeholder:text-base-content/30" 
                @keyup.enter="handleLogin" 
              />
            </div>
            
            <button 
              class="btn btn-primary btn-lg w-full rounded-2xl font-bold shadow-xl shadow-primary/30 mt-4 h-14" 
              @click="handleLogin" 
              :disabled="loading"
            >
              <span v-if="loading" class="loading loading-spinner"></span>
              {{ loading ? 'ÁôªÂΩï‰∏≠...' : 'ÁôªÂΩï' }}
            </button>
          </div>
        </div>

        <!-- Toast Notification -->
        <div v-if="error" class="toast toast-top toast-center z-50">
            <div class="alert alert-error text-white shadow-lg rounded-2xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>{{ error }}</span>
            </div>
        </div>
      </div>
  </script>

  <!-- TEMPLATE: Dashboard -->
  <script type="text/x-template" id="dashboard-template">
    <div class="min-h-screen bg-base-200/50 pb-24 font-sans flex flex-col h-screen overflow-hidden">
        
        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 overflow-y-auto pb-24">
            <!-- TODAY TAB -->
            <div v-if="activeTab === 'today'" class="animate-fade-in">
                <!-- Header -->
                <header class="pt-8 px-6 pb-6 bg-base-100 rounded-b-[2.5rem] shadow-sm mb-6">
                   <div class="flex justify-between items-center mb-6">
                     <div>
                       <p class="text-sm text-base-content/60 font-medium">‰Ω†Â•ΩÔºå</p>
                       <h1 class="text-2xl font-black text-base-content">{{ authStore.userConfig?.username[0].text || 'Athlete' }}</h1>
                     </div>
                     <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-circle btn-ghost bg-base-200 hover:bg-base-300 border-none shadow-sm">
                           <span class="text-xl font-bold text-primary">{{ userInitial }}</span>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow-xl bg-base-100 rounded-2xl w-40 border border-base-200">
                          <li><a @click="logout" class="text-error font-medium">ÈÄÄÂá∫ÁôªÂΩï</a></li>
                        </ul>
                     </div>
                   </div>
            
                   <!-- Main Stats Card -->
                   <div class="bg-primary text-primary-content rounded-[2rem] p-6 shadow-xl shadow-primary/30 relative overflow-hidden">
                     <!-- Background Patterns -->
                     <div class="absolute top-0 right-0 -mt-8 -mr-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                     <div class="absolute bottom-0 left-0 -mb-8 -ml-8 w-32 h-32 bg-black/10 rounded-full blur-2xl"></div>
                     
                     <div class="flex justify-between items-end relative z-10">
                        <div>
                            <div class="text-primary-content/80 text-sm font-medium mb-1">‰ªäÊó•Ê∂àËÄó</div>
                            <div class="text-5xl font-black tracking-tight">{{ todayKcal }}</div>
                            <div class="text-primary-content/60 text-xs mt-2 font-medium">Âç°Ë∑ØÈáå</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">{{ todaySets }}</div>
                            <div class="text-primary-content/80 text-xs font-medium uppercase tracking-wide">ËøêÂä®ÁªÑÊï∞</div>
                        </div>
                     </div>
                   </div>
                </header>
            
                <!-- Quick Actions -->
                <div class="px-6 mb-8">
                   <div class="flex items-center justify-between mb-4">
                     <h3 class="font-bold text-lg text-base-content/90">Âø´ÈÄüËÆ∞ÂΩï</h3>
                     <button @click="fetchActions(true)" class="btn btn-ghost btn-xs text-primary" :class="{'loading': actionsLoading}">
                        <span v-if="!actionsLoading">‚Üª</span>
                     </button>
                   </div>
                   
                   <!-- Category Tabs -->
                   <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide">
                       <button 
                           v-for="cat in categories" 
                           :key="cat"
                           @click="activeCategory = cat"
                           class="btn btn-sm rounded-full transition-all border-none flex-shrink-0"
                           :class="activeCategory === cat ? 'bg-primary text-primary-content shadow-md shadow-primary/30' : 'bg-base-200 text-base-content/60'"
                       >
                           {{ cat }}
                       </button>
                   </div>

                   <div v-if="actionsLoading && allActions.length === 0" class="flex justify-center py-8">
                       <span class="loading loading-spinner text-primary"></span>
                   </div>

                   <div v-else class="grid grid-cols-4 gap-3">
                      <button 
                         v-for="action in filteredPreferredActions" 
                         :key="action.id"
                         @click="openModal(action)"
                         class="flex flex-col items-center justify-center p-2 rounded-2xl bg-base-100 border border-base-200 shadow-sm active:scale-95 transition-all h-28 relative group"
                      >
                         <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl mb-1" :class="action.color">
                             {{ action.icon }}
                         </div>
                         <div class="text-[10px] font-bold text-center leading-tight text-base-content/80 line-clamp-2">{{ action.label }}</div>
                      </button>

                      <!-- Add Button (Weak) -->
                      <button 
                          @click="openPreferenceModal"
                          class="flex flex-col items-center justify-center p-2 rounded-2xl border-2 border-dashed border-base-300 text-base-content/30 hover:border-primary/50 hover:text-primary transition-all h-28"
                      >
                          <div class="w-10 h-10 rounded-full bg-base-200 flex items-center justify-center text-xl mb-1">+</div>
                          <div class="text-[10px] font-bold">Ê∑ªÂä†</div>
                      </button>
                   </div>
                </div>

                <!-- Today's List -->
                <div class="px-6 pb-20">
                   <h3 class="font-bold text-lg text-base-content/90 mb-4">‰ªäÊó•ËÆ∞ÂΩï</h3>
                   <div class="relative border-l-2 border-base-300 space-y-8">
                      <!-- Loading Skeleton -->
                      <div v-if="initLoading" class="pl-6 space-y-4">
                          <div class="h-20 bg-base-100 rounded-2xl animate-pulse"></div>
                          <div class="h-20 bg-base-100 rounded-2xl animate-pulse opacity-60"></div>
                          <div class="h-20 bg-base-100 rounded-2xl animate-pulse opacity-30"></div>
                      </div>

                      <!-- Empty State -->
                      <div v-else-if="history.length === 0" class="pl-6 py-8 text-center text-base-content/40 italic">
                         ÊöÇÊó†ËøêÂä®ËÆ∞ÂΩïÔºåÂø´ÂéªÂä®Ëµ∑Êù•ÂêßÔºÅ
                      </div>
                      
                      <!-- List -->
                      <div 
                         v-else
                         v-for="(record, index) in history.slice(0, 10)" 
                         :key="record.id"
                         class="relative pl-6 group"
                      >
                         <!-- Timeline Dot -->
                         <div class="absolute -left-[7px] top-6 w-4 h-4 rounded-full border-2 border-base-100" :class="index === 0 ? 'bg-primary ring-4 ring-primary/20' : 'bg-base-300'"></div>
                         
                         <!-- Content -->
                         <div class="bg-base-100 p-4 rounded-2xl shadow-sm border border-base-100 flex justify-between items-center transition-transform">
                            <div class="flex items-center gap-3">
                               <div class="w-10 h-10 rounded-xl bg-base-200 flex items-center justify-center text-xl">
                                  {{ getIcon(record.actionType) }}
                               </div>
                               <div>
                                  <div class="font-bold text-base-content">{{ record.actionType }}</div>
                                  <div class="text-xs text-base-content/50 font-medium">{{ formatTime(record.date) }}</div>
                               </div>
                            </div>
                            
                            <div class="text-right pr-6">
                               <div class="font-black text-lg text-base-content">{{ record.count }} <span class="text-xs font-medium text-base-content/40">Ê¨°</span></div>
                               <div class="text-xs font-bold text-primary">{{ record.kcal }} kcal</div>
                            </div>
            
                            <!-- Delete Button -->
                            <button 
                               @click.stop="deleteRecord(record.id)"
                               class="btn btn-ghost btn-xs text-error absolute -right-0 top-1/2 -translate-y-1/2 group-hover:opacity-100 transition-opacity"
                               :class="{'opacity-100': deletingId === record.id}"
                            >
                               <span v-if="deletingId === record.id" class="loading loading-spinner loading-xs"></span>
                               <span v-else>üóëÔ∏è</span>
                            </button>
                         </div>
                      </div>
                   </div>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div v-else-if="activeTab === 'history'" class="animate-fade-in px-6 pt-8">
                <h1 class="text-3xl font-black text-base-content mb-8">ÂéÜÂè≤ËÆ∞ÂΩï</h1>
                
                <div v-if="historyLoading" class="flex justify-center py-20">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </div>

                <div v-else>
                    <!-- History Heatmap View -->
                    <div class="bg-base-100 p-4 rounded-3xl shadow-sm border border-base-100 overflow-hidden mb-6" style="overflow: visible !important;">
                        <div class="overflow-x-auto pb-2 scrollbar-hide" style="direction: rtl; overflow: visible !important;">
                            <!-- Grid Container (Reversed direction for RTL to start from right) -->
                            <div class="grid grid-rows-7 grid-flow-col gap-1 w-max ltr" style="direction: ltr;">
                               <div 
                                  v-for="(day, index) in heatmapData" 
                                  :key="index"
                                  class="w-3 h-3 rounded-[2px] transition-colors hover:ring-2 ring-primary/50 relative group cursor-pointer"
                                  :class="[day.color, {'invisible': day.invisible}]"
                               >
                                  <!-- Tooltip -->
                                  <div v-if="!day.invisible" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10 transition-opacity">
                                      {{ day.date }}: {{ day.count }} ÁªÑ
                                  </div>
                               </div>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="flex items-center justify-end gap-2 mt-4 text-xs text-base-content/40">
                            <span>Â∞ë</span>
                            <div class="w-3 h-3 rounded-[2px] bg-base-200"></div>
                            <div class="w-3 h-3 rounded-[2px] bg-green-200"></div>
                            <div class="w-3 h-3 rounded-[2px] bg-green-400"></div>
                            <div class="w-3 h-3 rounded-[2px] bg-green-600"></div>
                            <span>Â§ö</span>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="p-5 bg-gradient-to-br from-base-100 to-base-200 rounded-3xl border border-base-100 shadow-sm mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">üìä</div>
                            <h4 class="font-bold text-base-content/80">Êú¨ÊúàÁªüËÆ°</h4>
                        </div>
                        <p class="text-base-content font-medium leading-relaxed">
                            {{ historyStatsText }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- PUMP TAB -->
            <div v-else-if="activeTab === 'pump'" class="h-full relative flex flex-col items-center justify-center overflow-hidden bg-base-100 animate-fade-in" style="background-color: inherit;">
                <!-- Swipeable Cards Container -->
                <div class="relative w-full max-w-md h-[65vh] flex items-center justify-center perspective-1000">
                    
                    <div v-if="pumpLoading" class="loading loading-spinner loading-lg text-primary"></div>
                    
                    <div v-else-if="pumpData.length === 0" class="text-center p-8">
                        <h2 class="text-2xl font-bold mb-2">ÊöÇÊó†Êï∞ÊçÆ</h2>
                        <button @click="fetchPumpData" class="btn btn-primary btn-sm">ÈáçËØï</button>
                    </div>

                    <div 
                        v-else
                        class="absolute w-full h-full p-4"
                        :style="cardStyle"
                        @touchstart="onCardTouchStart"
                        @touchmove="onCardTouchMove"
                        @touchend="onCardTouchEnd"
                        @mousedown="onCardTouchStart"
                        @mousemove="onCardTouchMove"
                        @mouseup="onCardTouchEnd"
                        @mouseleave="onCardTouchEnd"
                    >
                        <!-- Card -->
                        <div class="w-full h-full bg-white rounded-[2rem] shadow-2xl border border-base-200 flex flex-col overflow-hidden relative select-none cursor-grab active:cursor-grabbing">
                            <!-- Cover Image -->
                            <div v-if="currentCard.cover" class="h-1/2 w-full bg-gray-100 overflow-hidden relative">
                                <img :src="currentCard.cover" class="w-full h-full object-cover pointer-events-none" alt="Cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                                <div class="absolute bottom-4 left-4 right-4">
                                     <span class="inline-block px-3 py-1 bg-primary/90 text-primary-content text-xs font-bold rounded-full backdrop-blur-sm mb-1">
                                        {{ currentCard.category }}
                                     </span>
                                </div>
                            </div>
                            <!-- No Cover State -->
                            <div v-else class="h-1/3 w-full bg-gradient-to-br from-base-200 to-base-100 flex items-center justify-center relative">
                                <div class="absolute bottom-4 left-4">
                                     <span class="inline-block px-3 py-1 bg-base-300 text-base-content/60 text-xs font-bold rounded-full mb-1">
                                        {{ currentCard.category }}
                                     </span>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="flex-1 p-8 flex flex-col justify-center text-center relative">
                                <h3 
                                    class="font-normal text-base-content mb-6 leading-tight"
                                    :class="titleClass"
                                >
                                    {{ currentCard.title }}
                                </h3>
                                <p class="text-base-content/60 font-medium leading-relaxed text-lg line-clamp-4">{{ currentCard.content }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Text -->
                <div class="absolute bottom-24 text-center w-full px-6 opacity-40">
                    <p class="text-xs font-medium">Ê∞ÆÊ≥µÈáèÊúâÈôêÔºåÂäüËÉΩÊµãËØï‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖ~</p>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="btm-nav btm-nav-lg bg-base-100/90 backdrop-blur-md border-t border-base-200 z-40 rounded-t-3xl shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)]">
            <button 
                :class="activeTab === 'today' ? 'active text-primary bg-primary/10' : 'text-base-content/40 hover:text-base-content/60'"
                @click="activeTab = 'today'"
            >
                <span class="text-xl mb-1">üìÖ</span>
                <span class="btm-nav-label text-xs font-bold">‰ªäÊó•</span>
            </button>
            <button 
                :class="activeTab === 'history' ? 'active text-primary bg-primary/10' : 'text-base-content/40 hover:text-base-content/60'"
                @click="switchTab('history')"
            >
                <span class="text-xl mb-1">üìä</span>
                <span class="btm-nav-label text-xs font-bold">ÂéÜÂè≤</span>
            </button>
            <button 
                :class="activeTab === 'pump' ? 'active text-primary bg-primary/10' : 'text-base-content/40 hover:text-base-content/60'"
                @click="switchTab('pump')"
            >
                <span class="text-xl mb-1">‚ö°Ô∏è</span>
                <span class="btm-nav-label text-xs font-bold">Ê∞ÆÊ≥µ</span>
            </button>
        </div>

        <number-selector-modal 
          :is-open="isModalOpen" 
          :title="currentAction.label" 
          :description="currentAction.description"
          :kcal-per-rep="currentAction.kcal" 
          :loading="loading"
          @close="closeModal" 
          @confirm="handleConfirm" 
        ></number-selector-modal>

        <preference-selector-modal
          :is-open="isPreferenceModalOpen"
          :category="activeCategory"
          :actions="currentCategoryActions"
          :initial-selected="initialModalSelected"
          :loading="preferenceSaving"
          @close="closePreferenceModal"
          @save="savePreferences"
        ></preference-selector-modal>

        <rest-timer-modal 
          :is-open="isRestTimerOpen" 
          @close="isRestTimerOpen = false"
        ></rest-timer-modal>
    </div>
  </script>

  <!-- TEMPLATE: Modal -->
  <script type="text/x-template" id="modal-template">
    <div v-if="isOpen" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="close"></div>
        
        <!-- Modal Content -->
        <div class="relative w-full max-w-lg bg-base-100 rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 shadow-2xl transform transition-transform animate-slide-up overflow-hidden">
          <!-- Drag Handle -->
          <div class="w-12 h-1.5 bg-base-300 rounded-full mx-auto mb-6 opacity-50"></div>
          
          <div class="text-center mb-8">
             <h3 class="text-2xl font-black text-base-content mb-1">{{ title }}</h3>
             <p v-if="description" class="text-sm text-base-content/60 font-medium mb-2 px-8 leading-relaxed">{{ description }}</p>
             <div class="inline-flex items-center gap-1.5 px-3 py-1 bg-primary/10 text-primary rounded-full text-xs font-bold uppercase tracking-wide mt-1">
                <span>üî•</span>
                <span>{{ kcalPerRep }} ÂçÉÂç° / Ê¨°</span>
             </div>
          </div>
          
          <!-- Main Counter -->
          <div class="flex items-center justify-between gap-4 mb-10 px-4">
              <button 
                class="btn btn-circle btn-xl bg-base-200 hover:bg-base-300 border-none text-2xl h-16 w-16 shadow-inner active:scale-95 transition-transform"
                @click="decrement"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4" /></svg>
              </button>
              
              <div class="flex flex-col items-center">
                 <input 
                    type="number" 
                    :value="count" 
                    @input="e => updateCount(e.target.value)"
                    class="text-7xl font-black text-center w-40 bg-transparent border-none focus:ring-0 p-0 tabular-nums tracking-tighter"
                 />
                 <span class="text-sm font-bold text-base-content/40 uppercase tracking-widest mt-[-5px]">Ê¨°</span>
              </div>
              
              <button 
                class="btn btn-circle btn-xl bg-base-200 hover:bg-base-300 border-none text-2xl h-16 w-16 shadow-inner active:scale-95 transition-transform"
                @click="increment"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
              </button>
          </div>
          
          <!-- Presets -->
          <div class="flex justify-between gap-2 mb-8 overflow-x-auto pb-2 px-1 scrollbar-hide">
             <button 
                v-for="preset in presets" 
                :key="preset"
                @click="selectPreset(preset)"
                class="btn btn-md rounded-2xl flex-1 font-bold border-none transition-all"
                :class="count === preset ? 'bg-primary text-primary-content shadow-lg shadow-primary/30' : 'bg-base-200 text-base-content/60 hover:bg-base-300'"
             >
                {{ preset }}
             </button>
          </div>
          
          <!-- Info & Actions -->
          <div class="bg-base-200/50 rounded-3xl p-4 mb-6 flex items-center justify-between">
              <div class="flex flex-col pl-2">
                 <span class="text-xs font-bold text-base-content/50 uppercase">È¢ÑËÆ°Ê∂àËÄó</span>
                 <span class="text-2xl font-black text-primary">{{ estimatedKcal }} <span class="text-sm text-base-content/40 font-medium">kcal</span></span>
              </div>
              <button 
                  class="btn btn-primary btn-lg rounded-2xl px-8 font-bold shadow-xl shadow-primary/20" 
                  @click="confirm"
                  :disabled="loading"
              >
                 <span v-if="loading" class="loading loading-spinner"></span>
                 <span v-else>‰øùÂ≠òËÆ∞ÂΩï</span>
              </button>
          </div>
        </div>
      </div>
  </script>

  <!-- TEMPLATE: Rest Timer Modal -->
  <script type="text/x-template" id="rest-timer-template">
    <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
        
        <!-- Content -->
        <div class="relative w-full max-w-sm mx-6 bg-base-100 rounded-[2.5rem] p-8 shadow-2xl text-center overflow-hidden animate-slide-up">
            <!-- Decorative Background -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-secondary"></div>
            
            <h3 class="text-2xl font-black text-base-content mb-2">‰ºëÊÅØ‰∏Ä‰∏ã</h3>
            <p class="text-base-content/60 font-medium mb-8">ÂáÜÂ§á‰∏ã‰∏ÄÁªÑËÆ≠ÁªÉ</p>
            
            <!-- Timer Circle -->
            <div class="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center">
                <svg class="w-full h-full -rotate-90 transform" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" class="text-base-200" stroke-width="8" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" class="text-primary transition-all duration-1000 ease-linear" stroke-width="8" :stroke-dasharray="283" :stroke-dashoffset="283 - (283 * timeLeft / totalTime)" stroke-linecap="round" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center flex-col">
                    <span class="text-6xl font-black tabular-nums tracking-tighter">{{ timeLeft }}</span>
                    <span class="text-xs font-bold text-base-content/40 uppercase tracking-widest mt-1">Áßí</span>
                </div>
            </div>
            
            <button 
                class="btn btn-ghost btn-lg w-full rounded-2xl font-bold text-base-content/60 hover:text-base-content hover:bg-base-200" 
                @click="stop"
            >
                ÂºÄÂßã‰∏ã‰∏ÄÁªÑ
            </button>
        </div>
    </div>
  </script>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('SW registered:', registration);
          })
          .catch(error => {
            console.log('SW registration failed:', error);
          });
      });
    }

    const { createApp, ref, computed, watch, onMounted, onUnmounted, defineComponent, toRef } = Vue; // Added toRef
    const { createRouter, createWebHashHistory, useRouter } = VueRouter;
    const { defineStore, createPinia } = Pinia;

    // --- Store ---
    const useAuthStore = defineStore('auth', () => {
      const userConfig = ref(JSON.parse(localStorage.getItem('userConfig')) || null);
      
      function login(config) {
        userConfig.value = config;
        localStorage.setItem('userConfig', JSON.stringify(config));
      }

      function logout() {
        userConfig.value = null;
        localStorage.removeItem('userConfig');
        window.location.hash = '#/login'; 
      }

      return { userConfig, login, logout };
    });

    // --- Components ---

    // NumberSelectorModal
    const NumberSelectorModal = defineComponent({
      template: '#modal-template',
      props: ['isOpen', 'title', 'description', 'kcalPerRep', 'loading'], 
      emits: ['close', 'confirm'],
      setup(props, { emit }) {
        const count = ref(10);
        const presets = [10, 20, 30, 40, 50];

        watch(() => props.isOpen, (newVal) => {
          if (newVal) {
            count.value = 10;
          }
        });

        const estimatedKcal = computed(() => {
          return (count.value * props.kcalPerRep).toFixed(1);
        });

        const increment = () => {
          if (navigator.vibrate) navigator.vibrate(50);
          count.value++;
        };
        const decrement = () => {
          if (navigator.vibrate) navigator.vibrate(50);
          if (count.value > 1) count.value--;
        };
        
        const updateCount = (val) => {
            let num = parseInt(val);
            if (!isNaN(num) && num > 0) {
                count.value = num;
            }
        }

        const selectPreset = (val) => {
          if (navigator.vibrate) navigator.vibrate(50);
          count.value = val;
        };

        const confirm = () => {
          if (navigator.vibrate) navigator.vibrate(50);
          emit('confirm', count.value, estimatedKcal.value);
        };

        const close = () => {
          if (!props.loading) { // Prevent closing while loading
            emit('close');
          }
        };
        
        const loading = computed(() => props.loading);

        return { count, presets, estimatedKcal, increment, decrement, updateCount, selectPreset, confirm, close, loading };
      }
    });

    // Rest Timer Modal
    const RestTimerModal = defineComponent({
      template: '#rest-timer-template',
      props: ['isOpen'],
      emits: ['close'],
      setup(props, { emit }) {
        const totalTime = 60;
        const timeLeft = ref(totalTime);
        let timer = null;

        const startTimer = () => {
            if (timer) clearInterval(timer);
            timeLeft.value = totalTime;
            timer = setInterval(() => {
                if (timeLeft.value > 0) {
                    timeLeft.value--;
                } else {
                    if (navigator.vibrate) navigator.vibrate(50);
                    clearInterval(timer);
                    timer = null;
                }
            }, 1000);
        };

        const stopTimer = () => {
            if (timer) clearInterval(timer);
            timer = null;
        };

        watch(() => props.isOpen, (newVal) => {
            if (newVal) {
                startTimer();
            } else {
                stopTimer();
            }
        });

        const stop = () => {
            stopTimer();
            emit('close');
        };

        onUnmounted(() => {
            stopTimer();
            });

        return { timeLeft, totalTime, stop };
      }
    });

    // Preference Selector Modal
    const PreferenceSelectorModal = defineComponent({
      template: '#preference-selector-template',
      props: ['isOpen', 'category', 'actions', 'initialSelected', 'loading'],
      emits: ['close', 'save'],
      setup(props, { emit }) {
        const selectedIds = ref([]);

        watch(() => props.isOpen, (newVal) => {
            if (newVal) {
                selectedIds.value = [...props.initialSelected];
            }
        });

        const toggle = (id) => {
            if (navigator.vibrate) navigator.vibrate(50);
            const index = selectedIds.value.indexOf(id);
            if (index > -1) {
                selectedIds.value.splice(index, 1);
            } else {
                selectedIds.value.push(id);
            }
        };

        const isSelected = (id) => selectedIds.value.includes(id);

        const save = () => {
            emit('save', selectedIds.value);
        };

        const close = () => {
            if (!props.loading) {
                emit('close');
            }
        };

        return { toggle, isSelected, save, close };
      }
    });

    // Login
    const Login = defineComponent({
      template: '#login-template',
      setup() {
        const router = useRouter();
        const authStore = useAuthStore();
        
        const username = ref('');
        const password = ref('');
        const loading = ref(false);
        const error = ref('');

        const handleLogin = async () => {
          loading.value = true;
          error.value = '';
          
          try {
            const response = await axios.post('/api/login', {
              username: username.value,
              password: password.value,
            });
            
            if (response.data.success) {
              authStore.login(response.data.userConfig);
              router.push('/');
            }
          } catch (err) {
            error.value = err.response?.data?.error || 'Login failed';
            setTimeout(() => {
              error.value = '';
            }, 3000);
          } finally {
            loading.value = false;
          }
        };
        
        return { username, password, loading, error, handleLogin };
      }
    });

    // Dashboard
    const Dashboard = defineComponent({
      template: '#dashboard-template',
      components: { NumberSelectorModal, RestTimerModal, PreferenceSelectorModal },
      setup() {
        const authStore = useAuthStore();
        const history = ref([]);
        const allHistory = ref([]);
        const historyLoading = ref(false); // New
        const activeTab = ref('today'); // 'today', 'history', 'pump'
        const isModalOpen = ref(false);
        const isRestTimerOpen = ref(false);
        const currentAction = ref({});
        const loading = ref(false);
        const initLoading = ref(true);
        const deletingId = ref(null);
        
        // Pump Data
        const pumpData = ref([]);
        const currentCardIndex = ref(0);
        const pumpLoading = ref(false);
        const cardX = ref(0);
        const cardY = ref(0);
        const cardRotation = ref(0);
        const isDragging = ref(false);
        const isAnimating = ref(false); // New
        const isResetting = ref(false); // New
        
        // Touch handling for general swipe (removed for tabs, but kept logic vars if needed)
        // const touchStartX = ref(0);
        // const touchEndX = ref(0);
        
        const allActions = ref([]);
        const actionsLoading = ref(false);

        // --- Preference Logic ---
        const categories = ['ËÉå', 'ËÉ∏', 'ËÇ©', 'ËÖø', 'Ê†∏ÂøÉ', 'ÊâãËáÇ'];
        const activeCategory = ref('ËÉå');
        const preferredActions = ref([]); // List of action IDs
        const isPreferenceModalOpen = ref(false);
        const preferenceSaving = ref(false);

        // Load preferred actions
        onMounted(() => {
            // Priority: LocalStorage -> UserConfig (fallback)
            let loaded = false;
            const local = localStorage.getItem('preferredActions');
            if (local) {
                try {
                    preferredActions.value = JSON.parse(local);
                    loaded = true;
                } catch(e) {}
            }
            
            if (!loaded) {
                const config = authStore.userConfig;
                if (config && config.preferredAction && Array.isArray(config.preferredAction) && config.preferredAction.length > 0) {
                    preferredActions.value = config.preferredAction;
                }
            }
        });

        const getCategoryMatch = (action, category) => {
            const cat = action.target_muscle_group || '';
            return cat.includes(category) || 
                   (category === 'ËÖø' && cat.includes('Leg')) ||
                   (category === 'Ê†∏ÂøÉ' && (cat.includes('ËÖπ') || cat.includes('Abs'))) ||
                   (category === 'ÊâãËáÇ' && cat.includes('ËáÇ'));
        };

        // Computed: Actions in current category that are preferred
        const filteredPreferredActions = computed(() => {
            return allActions.value.filter(a => {
                const matchCategory = getCategoryMatch(a, activeCategory.value);
                return matchCategory && preferredActions.value.includes(a.id);
            });
        });

        // Computed: All actions in current category (for modal)
        const currentCategoryActions = computed(() => {
            return allActions.value.filter(a => {
                return getCategoryMatch(a, activeCategory.value);
            });
        });
        
        // Computed: Initial selected IDs for modal
        const initialModalSelected = computed(() => {
            // We want to pass IDs that are currently preferred AND in this category
            // But actually, the modal should show ALL preferred IDs for this category as selected.
            // Which is exactly what filteredPreferredActions contains.
            return filteredPreferredActions.value.map(a => a.id);
        });

        const openPreferenceModal = () => {
            isPreferenceModalOpen.value = true;
        };

        const closePreferenceModal = () => {
            isPreferenceModalOpen.value = false;
        };

        const savePreferences = async (selectedIds) => {
            preferenceSaving.value = true;
            try {
                // Remove existing prefs for this category
                const currentCatActionIds = currentCategoryActions.value.map(a => a.id);
                const otherPreferences = preferredActions.value.filter(id => !currentCatActionIds.includes(id));
                
                // Add new prefs
                const newPreferredActions = [...otherPreferences, ...selectedIds];
                preferredActions.value = newPreferredActions;

                // Save locally
                localStorage.setItem('preferredActions', JSON.stringify(newPreferredActions));
                
                // Cloud sync removed per user request - Local Storage Only
                
                closePreferenceModal();
            } catch (error) {
                console.error('Failed to save preferences:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                preferenceSaving.value = false;
            }
        };

        const fetchActions = async (force = false) => {
            actionsLoading.value = true;
            try {
                // Check cache
                const cached = localStorage.getItem('cachedActions');
                if (!force && cached) {
                    allActions.value = JSON.parse(cached);
                    // If we have cache, we can still fetch in background to update, or just return.
                    // For now, if we have cache, we assume it's good unless forced.
                    if (allActions.value.length > 0) {
                        actionsLoading.value = false;
                        return;
                    }
                }

                const response = await axios.get('/api/get-actions');
                if (response.data.success) {
                    const mapped = response.data.data.map(item => {
                        
                        const name = item.name || 'Unknown';
                        const label = item.label || item.name;// Â¶ÇÊûúÊ≤°Êúâ label Â∞±Áî® name ÂÖúÂ∫ï
                        const desc = item.description || '';
                        const muscle = item.target_muscle_group || 'ÂÖ∂‰ªñ';
                        // Êà™ÂõæÈáå category ÊòØ‰∏™Êï∞ÁªÑ ["Ëá™Áî±ÈáçÈáè", "Â±ÖÂÆ∂"]ÔºåÂ¶ÇÊûúÊúâÁî®Âà∞‰πüÂèØ‰ª•Âèñ
                        // category: item.category || []
                        
                        // Assign icon/color based on muscle or random
                        let icon = 'üèãÔ∏è';
                        let color = 'bg-primary/5 text-primary';
                        
                        if (muscle.includes('ËÉ∏')) { icon = 'üí™'; color = 'bg-blue-100 text-blue-600'; }
                        else if (muscle.includes('ËÉå')) { icon = 'ü¶ç'; color = 'bg-purple-100 text-purple-600'; }
                        else if (muscle.includes('ËÖø') || muscle.includes('Leg')) { icon = 'ü¶µ'; color = 'bg-orange-100 text-orange-600'; }
                        else if (muscle.includes('ËÖπ') || muscle.includes('Abs')) { icon = 'üßò'; color = 'bg-green-100 text-green-600'; }
                        else if (muscle.includes('ËÇ©')) { icon = 'ü§∑'; color = 'bg-red-100 text-red-600'; }
                        else if (muscle.includes('ËáÇ')) { icon = 'ü¶æ'; color = 'bg-indigo-100 text-indigo-600'; }

                        return {
                            id: item.name, // Use name as unique ID since database has no ID column
                            name: name, // English Name (for saving)
                            label: label, // Chinese Label (for display)
                            description: desc,
                            target_muscle_group: muscle,
                            kcal: 0.3, // Default
                            icon: icon,
                            color: color
                        };
                    });
                    
                    allActions.value = mapped;
                    localStorage.setItem('cachedActions', JSON.stringify(mapped));
                }
            } catch (e) {
                console.error('Failed to fetch actions:', e);
                // Fallback to hardcoded if empty?
                if (allActions.value.length === 0) {
                     allActions.value = [
                        { id: 'pull_ups', name: 'Pull Up', label: 'Âºï‰ΩìÂêë‰∏ä', kcal: 0.5, icon: 'üí™', color: 'bg-blue-100 text-blue-600', target_muscle_group: 'ËÉåÈÉ®' },
                        { id: 'push_ups', name: 'Push Up', label: '‰øØÂçßÊíë', kcal: 0.2, icon: 'ü§∏', color: 'bg-purple-100 text-purple-600', target_muscle_group: 'ËÉ∏ÈÉ®' }
                     ];
                }
            } finally {
                actionsLoading.value = false;
            }
        };

        const groupedActions = computed(() => {
            const groups = {};
            // Sort by muscle group to ensure consistent order if needed
            allActions.value.forEach(action => {
                const groupName = action.target_muscle_group || 'ÂÖ∂‰ªñ';
                if (!groups[groupName]) groups[groupName] = [];
                groups[groupName].push(action);
            });
            return groups;
        });

        onMounted(async () => {
          await fetchActions();
          await fetchHistory('today');
        });

        const fetchHistory = async (range = 'today') => {
            const config = authStore.userConfig?.configuration;
            const userId = authStore.userConfig?.userId;
            
            if (!config || !userId) {
                initLoading.value = false;
                return;
            }

            if (range === 'all') historyLoading.value = true;

            try {
                const response = await axios.post('/api/get-history', {
                    userId: userId,
                    appToken: config.fs_app_token,
                    tableId: config.fs_table_id,
                    range: range
                });

                if (response.data.success) {
                    const mappedData = response.data.data.map(item => {
                        const fields = item.fields;
                        // Handle Feishu text field format (array of objects or direct string)
                        let actionId = fields.training_types;
                        if (Array.isArray(actionId) && actionId.length > 0 && actionId[0].text) {
                            actionId = actionId[0].text;
                        }
                        
                        const action = allActions.value.find(a => a.name === actionId || a.label === actionId || a.id === actionId);
                        
                        let kcal = fields.Kcal_Burned;
                        if (!kcal && action) {
                            kcal = (fields.count * action.kcal).toFixed(1);
                        }

                        return {
                            id: item.id,
                            date: item.createdTime,
                            actionType: action ? action.label : actionId,
                            count: fields.count,
                            kcal: kcal || 0
                        };
                    });

                    if (range === 'today') {
                        const todayStr = new Date().toDateString();
                        history.value = mappedData.filter(item => {
                            const d = new Date(item.date);
                            return d.toDateString() === todayStr;
                        });
                    } else {
                        allHistory.value = mappedData;
                    }
                }
            } catch (error) {
                console.error('Failed to fetch history:', error);
            } finally {
                initLoading.value = false;
                if (range === 'all') historyLoading.value = false;
            }
        };

        const switchTab = async (tab) => {
            activeTab.value = tab;
            if (tab === 'history' && allHistory.value.length === 0) {
                await fetchHistory('all');
            }
            if (tab === 'pump' && pumpData.value.length === 0) {
                await fetchPumpData();
            }
        };

        // --- Pump Logic ---
        const fetchPumpData = async () => {
            pumpLoading.value = true;
            try {
                const response = await axios.get('/api/get-pump');
                if (response.data.success && response.data.data) {
                    // Shuffle the data
                    const items = response.data.data;
                    for (let i = items.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [items[i], items[j]] = [items[j], items[i]];
                    }
                    
                    
                    // Map fields
                    pumpData.value = items.map(item => ({
                        id: item.id,
                        title: item.title ? item.title : '',
                        content: item.content ? item.content : '',
                        cover: item.cover ? item.cover : null,
                        category: item.categroy ? item.categroy : '', // Note: 'categroy' typo in user input/field name
                        music: item.music ? item.music : null
                    }));
                    currentCardIndex.value = 0;
                    console.log(pumpData.value)
                }
            } catch (error) {
                console.error('Failed to fetch pump data:', error);
            } finally {
                pumpLoading.value = false;
            }
        };

        const currentCard = computed(() => {
            if (pumpData.value.length === 0) return {};
            return pumpData.value[currentCardIndex.value] || {};
        });

        const cardStyle = computed(() => {
            if (isResetting.value) return { transform: 'none', transition: 'none' };
            
            // If dragging, follow finger (no transition). If animating (fly out/snap back), use transition.
            const transition = isDragging.value ? 'none' : 'transform 0.3s ease-out';
            return {
                transform: `translate(${cardX.value}px, ${cardY.value}px) rotate(${cardRotation.value}deg)`,
                transition: transition
            };
        });

        const titleClass = computed(() => {
            const title = currentCard.value.title || '';
            const len = title.length;
            
            if (len <= 4) return 'text-5xl';
            if (len <= 8) return 'text-4xl';
            if (len <= 15) return 'text-3xl';
            if (len <= 25) return 'text-2xl';
            return 'text-xl';
        });

        // Card Swipe Handlers
        let startX = 0;
        let startY = 0;

        const onCardTouchStart = (e) => {
            if (isAnimating.value) return;
            isDragging.value = true;
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            startX = clientX;
            startY = clientY;
        };

        const onCardTouchMove = (e) => {
            if (!isDragging.value) return;
            e.preventDefault(); // Prevent scrolling
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;
            
            cardX.value = deltaX;
            cardY.value = deltaY;
            cardRotation.value = deltaX * 0.1; // Rotate based on X movement
        };

        const onCardTouchEnd = (e) => {
            if (!isDragging.value) return;
            isDragging.value = false;
            
            const threshold = window.innerWidth / 3;
            if (Math.abs(cardX.value) > threshold) {
                // Swipe Out
                isAnimating.value = true;
                const direction = cardX.value > 0 ? 1 : -1;
                const screenWidth = window.innerWidth;
                
                // Fly out
                cardX.value = direction * screenWidth * 1.5;
                cardRotation.value = direction * 45;
                
                // Wait for animation then switch
                setTimeout(() => {
                    nextCard();
                    
                    // Instant reset without animation
                    isResetting.value = true;
                    cardX.value = 0;
                    cardY.value = 0;
                    cardRotation.value = 0;
                    isAnimating.value = false;
                    
                    setTimeout(() => {
                        isResetting.value = false;
                    }, 50);
                }, 300);
            } else {
                // Snap back
                isAnimating.value = true;
                cardX.value = 0;
                cardY.value = 0;
                cardRotation.value = 0;
                
                setTimeout(() => {
                    isAnimating.value = false;
                }, 300);
            }
        };

        const nextCard = () => {
            if (currentCardIndex.value < pumpData.value.length - 1) {
                currentCardIndex.value++;
            } else {
                // Loop back or fetch more? Loop for now
                currentCardIndex.value = 0;
                // Reshuffle?
            }
        };

        // --- End Pump Logic ---

        const heatmapData = computed(() => {
             if (allHistory.value.length === 0) return [];
             
             // Generate last 365 days
             const days = [];
             const today = new Date();
             const oneYearAgo = new Date();
             oneYearAgo.setDate(today.getDate() - 364);
             
             // Pad start to align with day of week (assuming Row 1 is Sunday)
             const startDay = oneYearAgo.getDay(); // 0-6
             for (let i = 0; i < startDay; i++) {
                 days.push({ date: '', count: 0, color: 'bg-transparent', invisible: true });
             }

             // Create map of date -> count
             const activityMap = {};
             allHistory.value.forEach(record => {
                 const dateStr = new Date(record.date).toDateString();
                 if (!activityMap[dateStr]) activityMap[dateStr] = 0;
                 activityMap[dateStr]++;
             });
 
             for (let d = new Date(oneYearAgo); d <= today; d.setDate(d.getDate() + 1)) {
                 const dateStr = d.toDateString();
                 const count = activityMap[dateStr] || 0;
                 let color = 'bg-base-200'; // default gray
                 if (count > 0) color = 'bg-green-200';
                 if (count > 2) color = 'bg-green-400';
                 if (count > 5) color = 'bg-green-600';
                 
                 days.push({
                     date: d.toLocaleDateString(),
                     count,
                     color,
                     invisible: false
                 });
             }
             return days;
         });

        const historyStatsText = computed(() => {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const thisMonthRecords = allHistory.value.filter(record => {
                const d = new Date(record.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const uniqueDays = new Set(thisMonthRecords.map(r => new Date(r.date).toDateString())).size;
            const totalSets = thisMonthRecords.length;

            return `Êú¨ÊúàÂÖ±ËøêÂä® ${uniqueDays} Â§©ÔºåÂÆåÊàêËøêÂä® ${totalSets} ÁªÑ`;
        });

        const todayRecords = computed(() => {
          const today = new Date().toDateString();
          return history.value.filter(record => new Date(record.date).toDateString() === today);
        });

        const todayKcal = computed(() => {
          return todayRecords.value.reduce((sum, record) => sum + parseFloat(record.kcal), 0).toFixed(1);
        });

        const todaySets = computed(() => todayRecords.value.length);

        const openModal = (action) => {
          currentAction.value = action;
          isModalOpen.value = true;
        };

        const closeModal = () => {
          isModalOpen.value = false;
        };

        const handleConfirm = async (count) => {
          if (!currentAction.value.id) return;
          
          loading.value = true;

          try {
            // Optimistic update removed per user request - waiting for backend
            
            // Sync with Server
            const config = authStore.userConfig?.configuration;
            const userId = authStore.userConfig?.userId;

            if (config && userId) {
                 const response = await axios.post('/api/submit-record', {
                  userId: userId,
                  appToken: config.fs_app_token,
                  tableId: config.fs_table_id,
                  trainingType: currentAction.value.name,
                  count: count
                });
                
                // Update local data directly instead of fetching from server
                if (response.data.success) {
                    const newRecord = response.data.data;
                    const createdMs = newRecord.created_at * 1000; // Convert seconds to ms
                    
                    // Find action info for display
                    const actionName = currentAction.value.name;
                    const actionDef = allActions.value.find(a => a.name === actionName);
                    
                    // Calculate kcal
                    const kcal = actionDef ? (newRecord.count * actionDef.kcal).toFixed(1) : 0;
                    
                    const localRecord = {
                        id: newRecord.id,
                        date: createdMs,
                        actionType: actionDef ? actionDef.label : actionName,
                        count: newRecord.count,
                        kcal: kcal
                    };
                    
                    // Add to today's history (assuming DESC order)
                    history.value.unshift(localRecord);
                    
                    // Add to all history if it has been loaded
                    if (allHistory.value.length > 0) {
                        allHistory.value.unshift(localRecord);
                    }
                }
                
                // Play finish sound
                const audio = new Audio('resources/finish.mp3');
                audio.play().catch(e => console.log('Audio play failed:', e));

                closeModal();
                isRestTimerOpen.value = true;
            } else {
                console.warn("Missing config or userId, skipping API sync");
                alert("Cannot sync: Missing configuration.");
                closeModal();
            }
            
          } catch (error) {
            console.error('Failed to submit record:', error);
            alert('Failed to sync with server.');
          } finally {
            loading.value = false;
          }
        };

        const deleteRecord = async (id) => {
          if (confirm('Á°ÆËÆ§Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) {
            deletingId.value = id;
            try {
                const config = authStore.userConfig?.configuration;
                const userId = authStore.userConfig?.userId;
                
                if (config && userId) {
                    await axios.post('/api/delete-record', {
                        userId: userId,
                        appToken: config.fs_app_token,
                        tableId: config.fs_table_id,
                        recordId: id
                    });
                    
                    // Remove from local list after successful backend deletion
                    history.value = history.value.filter(item => item.id !== id);
                } else {
                    alert("ÈÖçÁΩÆÁº∫Â§±ÔºåÊó†Ê≥ïÂà†Èô§‰∫ëÁ´ØËÆ∞ÂΩï„ÄÇ");
                }
            } catch (error) {
                console.error("Failed to delete record:", error);
                alert("Âà†Èô§‰∫ëÁ´ØËÆ∞ÂΩïÂ§±Ë¥•„ÄÇ");
            } finally {
                deletingId.value = null;
            }
          }
        };

        const logout = () => {
          authStore.logout();
        };

        const userInitial = computed(() => {
            const name = authStore.userConfig?.username || authStore.userConfig?.nickname || 'Athlete';
            try {
                if (Array.isArray(name)) {
                    return String(name[0]?.text || name[0] || 'U').charAt(0).toUpperCase();
                }
                return String(name).charAt(0).toUpperCase();
            } catch (e) {
                return 'U';
            }
        });

        const getIcon = (name) => {
          const action = allActions.value.find(a => a.label === name || a.name === name);
          return action ? action.icon : 'üìù';
        };

        const getActionColor = (name) => {
            const action = allActions.value.find(a => a.label === name || a.name === name);
            return action ? action.color : 'bg-gray-100 text-gray-600';
        }

        const formatTime = (dateStr) => {
          return new Date(dateStr).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        };

        return { 
          authStore, 
          history, 
          isModalOpen, 
          currentAction, 
          loading, 
          initLoading, 
          allActions,
          groupedActions,
          fetchActions,
          actionsLoading,
          todayRecords, 
          todayKcal, 
          todaySets,
          openModal, 
          closeModal, 
          handleConfirm, 
          deleteRecord, 
          logout,
          getIcon, 
          getActionColor, 
          formatTime, 
          userInitial, 
          deletingId,
          isRestTimerOpen,
          activeTab,
          switchTab,
          heatmapData,
          historyStatsText,
          allHistory,
          historyLoading, // Added this
          // Preferences
          categories,
          activeCategory,
          filteredPreferredActions,
          openPreferenceModal,
          closePreferenceModal,
          isPreferenceModalOpen,
          currentCategoryActions,
          initialModalSelected,
          preferenceSaving,
          savePreferences,
          // Pump
          pumpData,
          currentCard,
          cardStyle,
          pumpLoading,
          onCardTouchStart,
          onCardTouchMove,
          onCardTouchEnd,
          fetchPumpData,
          titleClass
        };
      }
    });

    // --- Router ---
    const router = createRouter({
      history: createWebHashHistory(),
      routes: [
        {
          path: '/login',
          name: 'Login',
          component: Login,
        },
        {
          path: '/',
          name: 'Dashboard',
          component: Dashboard,
          meta: { requiresAuth: true },
        },
      ],
    });

    router.beforeEach((to, from, next) => {
      const authStore = useAuthStore();
      if (to.meta.requiresAuth && !authStore.userConfig) {
        next('/login');
      } else if (to.path === '/login' && authStore.userConfig) {
        next('/');
      } else {
        next();
      }
    });

    // --- App Initialization ---
    const app = createApp({
      setup() {
        return {};
      }
    });

    app.use(createPinia());
    app.use(router);
    app.mount('#app');
  </script>
</body>
</html>
